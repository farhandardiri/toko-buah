<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Pembukuan Toko Buah</title>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #2ecc71;
        --secondary-color: #27ae60;
        --accent-color: #e74c3c;
        --warning-color: #f39c12;
      }

      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .navbar-brand {
        font-weight: 700;
      }

      .card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
        transition: transform 0.3s ease;
      }

      .card:hover {
        transform: translateY(-5px);
      }

      .card-header {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        color: white;
        border-radius: 15px 15px 0 0 !important;
        border: none;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        border: none;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
      }

      .nav-pills .nav-link {
        color: #2c3e50;
        padding: 12px 25px;
        margin: 0 5px;
        border-radius: 10px;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .nav-pills .nav-link.active {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
      }

      .stat-card {
        text-align: center;
        padding: 2rem 1rem;
      }

      .stat-card .number {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--primary-color);
      }

      .stock-low {
        background: linear-gradient(135deg, #ff6b6b, #ee5a52) !important;
        color: white;
      }

      .stock-low .number {
        color: white;
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <i class="bi bi-apple"></i> Toko Buah Segar
        </a>
        <div class="navbar-nav ms-auto">
          <span class="navbar-text" id="currentDateTime"></span>
        </div>
      </div>
    </nav>

    <div class="container-fluid py-4">
      <!-- Tabs Navigation -->
      <ul class="nav nav-pills mb-4 justify-content-center" id="mainTabs">
        <li class="nav-item">
          <a class="nav-link active" href="#dashboard" data-bs-toggle="tab">
            <i class="bi bi-speedometer2"></i> Dashboard
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#master" data-bs-toggle="tab">
            <i class="bi bi-database"></i> Master Data
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#transaksi" data-bs-toggle="tab">
            <i class="bi bi-cart"></i> Transaksi
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#laporan" data-bs-toggle="tab">
            <i class="bi bi-graph-up"></i> Laporan
          </a>
        </li>
      </ul>

      <div class="tab-content">
        <!-- Dashboard Tab -->
        <div class="tab-pane fade show active" id="dashboard">
          <div class="row mb-4">
            <div class="col-12">
              <h1 class="display-5 fw-bold text-white text-center">
                <i class="bi bi-dashboard"></i> Dashboard
              </h1>
            </div>
          </div>

          <!-- Summary Cards -->
          <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
              <div class="card bg-white">
                <div class="card-body stat-card">
                  <div class="number" id="totalPendapatan">Rp 0</div>
                  <div class="label">Pendapatan Bulan Ini</div>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
              <div class="card bg-white">
                <div class="card-body stat-card">
                  <div class="number" id="totalPengeluaran">Rp 0</div>
                  <div class="label">Pengeluaran Bulan Ini</div>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
              <div class="card bg-white">
                <div class="card-body stat-card">
                  <div class="number" id="labaBersih">Rp 0</div>
                  <div class="label">Laba Bersih</div>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
              <div class="card bg-white">
                <div class="card-body stat-card">
                  <div class="number" id="totalTransaksi">0</div>
                  <div class="label">Total Transaksi</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Stock Alert & Recent Transactions -->
          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title mb-0">
                    <i class="bi bi-exclamation-triangle"></i> Stok Menipis
                  </h5>
                </div>
                <div class="card-body">
                  <div id="stockAlerts">
                    <!-- Stock alerts will be loaded here -->
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title mb-0">
                    <i class="bi bi-clock-history"></i> Transaksi Terbaru
                  </h5>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Tanggal</th>
                          <th>Type</th>
                          <th>Deskripsi</th>
                          <th>Jumlah</th>
                        </tr>
                      </thead>
                      <tbody id="recentTransactions">
                        <!-- Recent transactions will be loaded here -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Master Data Tab -->
        <div class="tab-pane fade" id="master">
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h4 class="card-title mb-0">
                    <i class="bi bi-database"></i> Master Data Management
                  </h4>
                </div>
                <div class="card-body">
                  <ul class="nav nav-pills mb-3" id="masterTabs">
                    <li class="nav-item">
                      <a
                        class="nav-link active"
                        href="#masterBuah"
                        data-bs-toggle="tab"
                        >Data Buah</a
                      >
                    </li>
                    <li class="nav-item">
                      <a
                        class="nav-link"
                        href="#masterSupplier"
                        data-bs-toggle="tab"
                        >Supplier</a
                      >
                    </li>
                    <li class="nav-item">
                      <a
                        class="nav-link"
                        href="#masterPelanggan"
                        data-bs-toggle="tab"
                        >Pelanggan</a
                      >
                    </li>
                    <li class="nav-item">
                      <a
                        class="nav-link"
                        href="#masterBiaya"
                        data-bs-toggle="tab"
                        >Jenis Biaya</a
                      >
                    </li>
                  </ul>

                  <div class="tab-content">
                    <!-- Master Buah -->
                    <div class="tab-pane fade show active" id="masterBuah">
                      <button
                        class="btn btn-primary mb-3"
                        onclick="showModal('buah')"
                      >
                        <i class="bi bi-plus-circle"></i> Tambah Buah
                      </button>
                      <div class="table-responsive">
                        <table class="table table-striped">
                          <thead>
                            <tr>
                              <th>Kode</th>
                              <th>Nama Buah</th>
                              <th>Kategori</th>
                              <th>Satuan</th>
                              <th>Harga Beli</th>
                              <th>Harga Jual</th>
                              <th>Stok Min</th>
                              <th>Aksi</th>
                            </tr>
                          </thead>
                          <tbody id="tableMasterBuah">
                            <!-- Data will be loaded by JavaScript -->
                          </tbody>
                        </table>
                      </div>
                    </div>

                    <!-- Other master tabs will be similar -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Transaksi Tab -->
        <div class="tab-pane fade" id="transaksi">
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h4 class="card-title mb-0">
                    <i class="bi bi-cart"></i> Input Transaksi
                  </h4>
                </div>
                <div class="card-body">
                  <ul class="nav nav-pills mb-3" id="transaksiTabs">
                    <li class="nav-item">
                      <a
                        class="nav-link active"
                        href="#transaksiPembelian"
                        data-bs-toggle="tab"
                        >Pembelian</a
                      >
                    </li>
                    <li class="nav-item">
                      <a
                        class="nav-link"
                        href="#transaksiPenjualan"
                        data-bs-toggle="tab"
                        >Penjualan</a
                      >
                    </li>
                    <li class="nav-item">
                      <a
                        class="nav-link"
                        href="#transaksiOperasional"
                        data-bs-toggle="tab"
                        >Biaya Operasional</a
                      >
                    </li>
                  </ul>

                  <div class="tab-content">
                    <!-- Form Pembelian -->
                    <div
                      class="tab-pane fade show active"
                      id="transaksiPembelian"
                    >
                      <form id="formPembelian">
                        <div class="row">
                          <div class="col-md-6">
                            <div class="mb-3">
                              <label class="form-label">Tanggal</label>
                              <input
                                type="date"
                                class="form-control"
                                id="pembelianTanggal"
                                required
                              />
                            </div>
                            <div class="mb-3">
                              <label class="form-label">Supplier</label>
                              <select
                                class="form-select"
                                id="pembelianSupplier"
                                required
                              >
                                <option value="">Pilih Supplier</option>
                              </select>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="mb-3">
                              <label class="form-label">Buah</label>
                              <select
                                class="form-select"
                                id="pembelianBuah"
                                required
                              >
                                <option value="">Pilih Buah</option>
                              </select>
                            </div>
                            <div class="row">
                              <div class="col-6">
                                <div class="mb-3">
                                  <label class="form-label">Quantity</label>
                                  <input
                                    type="number"
                                    step="0.1"
                                    class="form-control"
                                    id="pembelianQty"
                                    required
                                  />
                                </div>
                              </div>
                              <div class="col-6">
                                <div class="mb-3">
                                  <label class="form-label">Harga Beli</label>
                                  <input
                                    type="number"
                                    class="form-control"
                                    id="pembelianHarga"
                                    required
                                  />
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Keterangan</label>
                          <textarea
                            class="form-control"
                            id="pembelianKeterangan"
                            rows="2"
                          ></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">
                          <i class="bi bi-check-circle"></i> Simpan Pembelian
                        </button>
                      </form>
                    </div>

                    <!-- Forms for Penjualan and Operasional will be similar -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Laporan Tab -->
        <div class="tab-pane fade" id="laporan">
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h4 class="card-title mb-0">
                    <i class="bi bi-graph-up"></i> Laporan Keuangan
                  </h4>
                </div>
                <div class="card-body">
                  <div class="row mb-3">
                    <div class="col-md-4">
                      <label class="form-label">Periode Dari</label>
                      <input
                        type="date"
                        class="form-control"
                        id="reportStartDate"
                      />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Periode Sampai</label>
                      <input
                        type="date"
                        class="form-control"
                        id="reportEndDate"
                      />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">&nbsp;</label>
                      <button
                        class="btn btn-primary w-100"
                        onclick="generateLaporan()"
                      >
                        <i class="bi bi-arrow-clockwise"></i> Generate Laporan
                      </button>
                    </div>
                  </div>

                  <!-- Laporan Laba Rugi -->
                  <div class="card mb-4">
                    <div class="card-header">
                      <h5 class="card-title mb-0">Laporan Laba Rugi</h5>
                    </div>
                    <div class="card-body">
                      <div id="laporanLabaRugi">
                        <!-- Laba Rugi report will be generated here -->
                      </div>
                    </div>
                  </div>

                  <!-- Laporan Stok -->
                  <div class="card">
                    <div class="card-header">
                      <h5 class="card-title mb-0">Laporan Stok Gudang</h5>
                    </div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table table-striped">
                          <thead>
                            <tr>
                              <th>Nama Buah</th>
                              <th>Stok Awal</th>
                              <th>Pembelian</th>
                              <th>Penjualan</th>
                              <th>Stok Akhir</th>
                              <th>Nilai Persediaan</th>
                            </tr>
                          </thead>
                          <tbody id="laporanStok">
                            <!-- Stock report will be generated here -->
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // ==================== CONFIGURATION ====================
      // Ganti dengan URL Web App Anda setelah deploy
      const WEB_APP_URL =
        "https://script.google.com/macros/s/AKfycbxT2V4rTO4C7l_1q0cpEH_s_L64hua4frZ5D62jrqjiK8xMEc5iZoMSPkZ23WbuR-reOQ/exec";

      const SHEETS = {
        MASTER_BUAH: "master_buah",
        MASTER_SUPPLIER: "master_supplier",
        MASTER_PELANGGAN: "master_pelanggan",
        MASTER_BIAYA: "master_jenis_biaya",
        TRANSAKSI_PEMBELIAN: "transaksi_pembelian",
        TRANSAKSI_PENJUALAN: "transaksi_penjualan",
        TRANSAKSI_OPERASIONAL: "transaksi_operasional",
      };

      // ==================== WEB APP API FUNCTIONS ====================
      async function getSheetData(sheetName) {
        try {
          const url = `${WEB_APP_URL}?action=getData&sheet=${sheetName}`;
          const response = await fetch(url, {
            method: "GET",
            redirect: "follow", // Follow redirects
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          if (result.error) {
            throw new Error(result.error);
          }

          return result.data || [];
        } catch (error) {
          console.error("Error fetching data:", error);
          throw new Error(
            `Gagal mengambil data dari ${sheetName}: ${error.message}`
          );
        }
      }
      async function appendToSheet(sheetName, data) {
        try {
          const url = `${WEB_APP_URL}?action=appendData&sheet=${sheetName}`;

          const response = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          if (result.error) {
            throw new Error(result.error);
          }

          return result;
        } catch (error) {
          console.error("Error appending data:", error);
          throw new Error(
            `Gagal menyimpan data ke ${sheetName}: ${error.message}`
          );
        }
      }

      // ==================== UTILITY FUNCTIONS ====================
      function formatCurrency(amount) {
        return new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: "IDR",
        }).format(amount);
      }

      function showAlert(message, type = "success") {
        const alertDiv = document.createElement("div");
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.setAttribute("role", "alert");
        alertDiv.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  `;

        const container = document.querySelector(".container-fluid");
        const tabContent = document.querySelector(".tab-content");

        try {
          if (container) {
            // Jika tabContent memang anak dari container -> insertBefore
            if (tabContent && container.contains(tabContent)) {
              container.insertBefore(alertDiv, tabContent);
            } else {
              // Jika tabContent tidak ada atau bukan anak container -> prepend ke container
              if (typeof container.prepend === "function") {
                container.prepend(alertDiv);
              } else {
                container.insertBefore(alertDiv, container.firstChild);
              }
            }
          } else {
            // fallback ke body
            if (typeof document.body.prepend === "function") {
              document.body.prepend(alertDiv);
            } else {
              document.body.insertBefore(alertDiv, document.body.firstChild);
            }
          }
        } catch (err) {
          // fallback aman jika terjadi error tak terduga
          console.error("showAlert insert error:", err);
          if (document.body) document.body.appendChild(alertDiv);
        }

        // Hapus alert setelah 5 detik jika masih terpasang
        setTimeout(() => {
          if (alertDiv && alertDiv.parentElement) alertDiv.remove();
        }, 5000);
      }

      // ==================== CORE BUSINESS LOGIC ====================
      class TokoBuahSystem {
        constructor() {
          this.masterData = {};
          this.transactions = {};
          this.isLoading = false;
        }

        async loadAllData() {
          if (this.isLoading) {
            console.log("Data sedang dimuat...");
            return;
          }

          this.isLoading = true;

          try {
            showAlert("Memuat data...", "info");

            // Load master data
            this.masterData.buah = await getSheetData(SHEETS.MASTER_BUAH);
            this.masterData.supplier = await getSheetData(
              SHEETS.MASTER_SUPPLIER
            );
            this.masterData.pelanggan = await getSheetData(
              SHEETS.MASTER_PELANGGAN
            );
            this.masterData.biaya = await getSheetData(SHEETS.MASTER_BIAYA);

            // Load transactions
            this.transactions.pembelian = await getSheetData(
              SHEETS.TRANSAKSI_PEMBELIAN
            );
            this.transactions.penjualan = await getSheetData(
              SHEETS.TRANSAKSI_PENJUALAN
            );
            this.transactions.operasional = await getSheetData(
              SHEETS.TRANSAKSI_OPERASIONAL
            );

            this.updateDashboard();
            this.updateMasterTables();
            this.populateDropdowns();

            showAlert("Data berhasil dimuat!", "success");
          } catch (error) {
            console.error("Error loading data:", error);
            showAlert("Error memuat data: " + error.message, "danger");
          } finally {
            this.isLoading = false;
          }
        }

        calculateCurrentStock(kodeBuah) {
          const pembelian = this.transactions.pembelian
            .slice(1)
            .filter((t) => t[3] === kodeBuah);
          const penjualan = this.transactions.penjualan
            .slice(1)
            .filter((t) => t[3] === kodeBuah);

          const totalPembelian = pembelian.reduce(
            (sum, t) => sum + parseFloat(t[4] || 0),
            0
          );
          const totalPenjualan = penjualan.reduce(
            (sum, t) => sum + parseFloat(t[4] || 0),
            0
          );

          return totalPembelian - totalPenjualan;
        }

        updateDashboard() {
          const currentMonth = new Date().getMonth();
          const currentYear = new Date().getFullYear();

          // Calculate monthly income/expense
          const penjualanBulanIni = this.transactions.penjualan
            .slice(1)
            .filter((t) => {
              const date = new Date(t[1]);
              return (
                date.getMonth() === currentMonth &&
                date.getFullYear() === currentYear
              );
            })
            .reduce((sum, t) => sum + parseFloat(t[9] || 0), 0);

          const pembelianBulanIni = this.transactions.pembelian
            .slice(1)
            .filter((t) => {
              const date = new Date(t[1]);
              return (
                date.getMonth() === currentMonth &&
                date.getFullYear() === currentYear
              );
            })
            .reduce((sum, t) => sum + parseFloat(t[6] || 0), 0);

          const biayaBulanIni = this.transactions.operasional
            .slice(1)
            .filter((t) => {
              const date = new Date(t[1]);
              return (
                date.getMonth() === currentMonth &&
                date.getFullYear() === currentYear
              );
            })
            .reduce((sum, t) => sum + parseFloat(t[3] || 0), 0);

          const totalPendapatan = document.getElementById("totalPendapatan");
          const totalPengeluaran = document.getElementById("totalPengeluaran");
          const labaBersih = document.getElementById("labaBersih");
          const totalTransaksi = document.getElementById("totalTransaksi");

          if (totalPendapatan)
            totalPendapatan.textContent = formatCurrency(penjualanBulanIni);
          if (totalPengeluaran)
            totalPengeluaran.textContent = formatCurrency(
              pembelianBulanIni + biayaBulanIni
            );
          if (labaBersih)
            labaBersih.textContent = formatCurrency(
              penjualanBulanIni - pembelianBulanIni - biayaBulanIni
            );
          if (totalTransaksi)
            totalTransaksi.textContent =
              this.transactions.penjualan.length -
              1 +
              this.transactions.pembelian.length -
              1;

          this.updateStockAlerts();
          this.updateRecentTransactions();
        }

        updateStockAlerts() {
          const alertsContainer = document.getElementById("stockAlerts");
          if (!alertsContainer) return;

          alertsContainer.innerHTML = "";

          this.masterData.buah.slice(1).forEach((buah) => {
            const [kode, nama, , , , , stokMin] = buah;
            const currentStock = this.calculateCurrentStock(kode);

            if (currentStock <= parseFloat(stokMin || 0)) {
              const alertDiv = document.createElement("div");
              alertDiv.className = "alert alert-warning";
              alertDiv.innerHTML = `
          <strong>${nama}</strong>: Stok ${currentStock} kg (Min: ${stokMin} kg)
        `;
              alertsContainer.appendChild(alertDiv);
            }
          });

          if (alertsContainer.children.length === 0) {
            alertsContainer.innerHTML =
              '<div class="text-center text-muted">Semua stok aman</div>';
          }
        }

        updateRecentTransactions() {
          const container = document.getElementById("recentTransactions");
          if (!container) return;

          container.innerHTML = "";

          const allTransactions = [
            ...this.transactions.pembelian
              .slice(1)
              .map((t) => ({ ...t, type: "PEMBELIAN" })),
            ...this.transactions.penjualan
              .slice(1)
              .map((t) => ({ ...t, type: "PENJUALAN" })),
            ...this.transactions.operasional
              .slice(1)
              .map((t) => ({ ...t, type: "BIAYA" })),
          ]
            .sort((a, b) => new Date(b[1]) - new Date(a[1]))
            .slice(0, 5);

          allTransactions.forEach((trans) => {
            const row = document.createElement("tr");
            let description = "";
            let amount = 0;

            if (trans.type === "PEMBELIAN") {
              const buah = this.masterData.buah.find((b) => b[0] === trans[3]);
              description = `Pembelian ${buah ? buah[1] : trans[3]}`;
              amount = -parseFloat(trans[6] || 0);
            } else if (trans.type === "PENJUALAN") {
              const buah = this.masterData.buah.find((b) => b[0] === trans[3]);
              description = `Penjualan ${buah ? buah[1] : trans[3]}`;
              amount = parseFloat(trans[9] || 0);
            } else {
              const biaya = this.masterData.biaya.find(
                (b) => b[0] === trans[2]
              );
              description = `Biaya ${biaya ? biaya[1] : trans[2]}`;
              amount = -parseFloat(trans[3] || 0);
            }

            row.innerHTML = `
        <td>${trans[1]}</td>
        <td><span class="badge ${
          trans.type === "PENJUALAN" ? "bg-success" : "bg-warning"
        }">${trans.type}</span></td>
        <td>${description}</td>
        <td class="${
          amount >= 0 ? "text-success" : "text-danger"
        }">${formatCurrency(Math.abs(amount))}</td>
      `;
            container.appendChild(row);
          });
        }

        updateMasterTables() {
          const tableBuah = document.getElementById("tableMasterBuah");
          if (!tableBuah) return;

          tableBuah.innerHTML = "";

          this.masterData.buah.slice(1).forEach((buah, index) => {
            const [
              kode,
              nama,
              kategori,
              satuan,
              hargaBeli,
              hargaJual,
              stokMin,
              status,
            ] = buah;
            const currentStock = this.calculateCurrentStock(kode);

            const row = document.createElement("tr");
            row.innerHTML = `
        <td>${kode}</td>
        <td>${nama}</td>
        <td>${kategori}</td>
        <td>${satuan}</td>
        <td>${formatCurrency(parseFloat(hargaBeli || 0))}</td>
        <td>${formatCurrency(parseFloat(hargaJual || 0))}</td>
        <td>${stokMin} ${satuan}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="editMasterData('buah', ${index})">
            <i class="bi bi-pencil"></i> Edit
          </button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteMasterData('buah', ${index})">
            <i class="bi bi-trash"></i> Hapus
          </button>
        </td>
      `;
            tableBuah.appendChild(row);
          });
        }

        populateDropdowns() {
          // Populate supplier dropdown
          const supplierSelect = document.getElementById("pembelianSupplier");
          if (supplierSelect) {
            supplierSelect.innerHTML =
              '<option value="">Pilih Supplier</option>';
            this.masterData.supplier.slice(1).forEach((supplier) => {
              const option = document.createElement("option");
              option.value = supplier[0];
              option.textContent = supplier[1];
              supplierSelect.appendChild(option);
            });
          }

          // Populate buah dropdown
          const buahSelect = document.getElementById("pembelianBuah");
          if (buahSelect) {
            buahSelect.innerHTML = '<option value="">Pilih Buah</option>';
            this.masterData.buah.slice(1).forEach((buah) => {
              const option = document.createElement("option");
              option.value = buah[0];
              option.textContent = `${
                buah[1]
              } (Stok: ${this.calculateCurrentStock(buah[0]).toFixed(1)} kg)`;
              option.setAttribute("data-harga", buah[4]);
              buahSelect.appendChild(option);
            });
          }
        }

        async simpanPembelian(data) {
          const noPembelian = `PO-${String(
            this.transactions.pembelian.length
          ).padStart(3, "0")}`;
          const rowData = [
            noPembelian,
            data.tanggal,
            data.kodeSupplier,
            data.kodeBuah,
            data.quantity,
            data.hargaBeli,
            data.quantity * data.hargaBeli,
            "LUNAS",
            data.keterangan,
          ];

          await appendToSheet(SHEETS.TRANSAKSI_PEMBELIAN, rowData);
          await this.loadAllData();
        }

        async generateLaporanLabaRugi(startDate, endDate) {
          const penjualan = this.transactions.penjualan.slice(1).filter((t) => {
            const date = new Date(t[1]);
            return date >= startDate && date <= endDate;
          });

          const pembelian = this.transactions.pembelian.slice(1).filter((t) => {
            const date = new Date(t[1]);
            return date >= startDate && date <= endDate;
          });

          const biaya = this.transactions.operasional.slice(1).filter((t) => {
            const date = new Date(t[1]);
            return date >= startDate && date <= endDate;
          });

          const totalPenjualan = penjualan.reduce(
            (sum, t) => sum + parseFloat(t[6] || 0),
            0
          );
          const totalPembelian = pembelian.reduce(
            (sum, t) => sum + parseFloat(t[6] || 0),
            0
          );
          const totalBiaya = biaya.reduce(
            (sum, t) => sum + parseFloat(t[3] || 0),
            0
          );

          const labaKotor = totalPenjualan - totalPembelian;
          const labaBersih = labaKotor - totalBiaya;

          return {
            totalPenjualan,
            totalPembelian,
            totalBiaya,
            labaKotor,
            labaBersih,
          };
        }
      }

      // ==================== MODAL MANAGEMENT ====================
      let currentMasterType = "";
      let editingData = null;

      function showModal(masterType, data = null) {
        currentMasterType = masterType;
        editingData = data;

        document.querySelectorAll("#masterModal form").forEach((form) => {
          form.style.display = "none";
        });

        document
          .querySelectorAll(
            "#masterModal input, #masterModal select, #masterModal textarea"
          )
          .forEach((input) => {
            input.value = "";
          });

        let modalTitle = "";
        switch (masterType) {
          case "buah":
            const formBuah = document.getElementById("formMasterBuah");
            if (formBuah) formBuah.style.display = "block";
            modalTitle = data ? "Edit Data Buah" : "Tambah Data Buah";
            if (data) {
              populateBuahForm(data);
            } else {
              generateAutoKode("buah");
            }
            break;
          case "supplier":
            const formSupplier = document.getElementById("formMasterSupplier");
            if (formSupplier) formSupplier.style.display = "block";
            modalTitle = data ? "Edit Data Supplier" : "Tambah Data Supplier";
            if (data) {
              populateSupplierForm(data);
            } else {
              generateAutoKode("supplier");
            }
            break;
          case "pelanggan":
            const formPelanggan = document.getElementById(
              "formMasterPelanggan"
            );
            if (formPelanggan) formPelanggan.style.display = "block";
            modalTitle = data ? "Edit Data Pelanggan" : "Tambah Data Pelanggan";
            if (data) {
              populatePelangganForm(data);
            } else {
              generateAutoKode("pelanggan");
            }
            break;
          case "biaya":
            const formBiaya = document.getElementById("formMasterBiaya");
            if (formBiaya) formBiaya.style.display = "block";
            modalTitle = data ? "Edit Data Biaya" : "Tambah Data Biaya";
            if (data) {
              populateBiayaForm(data);
            } else {
              generateAutoKode("biaya");
            }
            break;
        }

        const modalTitleEl = document.getElementById("masterModalTitle");
        if (modalTitleEl) modalTitleEl.textContent = modalTitle;

        const modalEl = document.getElementById("masterModal");
        if (modalEl) {
          const modal = new bootstrap.Modal(modalEl);
          modal.show();
        }
      }

      function generateAutoKode(type) {
        const prefixes = {
          buah: "BUAH",
          supplier: "SUP",
          pelanggan: "CUST",
          biaya: "BIAYA",
        };

        const prefix = prefixes[type];
        const existingData = system.masterData[type] || [];
        const nextNumber = existingData.length;

        const kodeInput = document.getElementById(`${type}Kode`);
        if (kodeInput) {
          kodeInput.value = `${prefix}-${String(nextNumber).padStart(3, "0")}`;
        }
      }

      function populateBuahForm(data) {
        const fields = [
          "Kode",
          "Nama",
          "Kategori",
          "Satuan",
          "HargaBeli",
          "HargaJual",
          "StokMin",
          "Status",
        ];
        fields.forEach((field, index) => {
          const el = document.getElementById(`buah${field}`);
          if (el) el.value = data[index] || "";
        });
      }

      function populateSupplierForm(data) {
        const fields = [
          "Kode",
          "Nama",
          "Kontak",
          "Alamat",
          "JenisBuah",
          "Terms",
        ];
        fields.forEach((field, index) => {
          const el = document.getElementById(`supplier${field}`);
          if (el) el.value = data[index] || "";
        });
      }

      function populatePelangganForm(data) {
        const fields = ["Kode", "Nama", "Jenis", "Kontak", "Alamat", "Limit"];
        fields.forEach((field, index) => {
          const el = document.getElementById(`pelanggan${field}`);
          if (el) el.value = data[index] || "";
        });
      }

      function populateBiayaForm(data) {
        const fields = [
          "Kode",
          "Nama",
          "Kategori",
          "SubKategori",
          "Budget",
          "Status",
        ];
        fields.forEach((field, index) => {
          const el = document.getElementById(`biaya${field}`);
          if (el) el.value = data[index] || "";
        });
      }

      async function saveMasterData() {
        try {
          let data = [];
          const sheetName = getSheetNameByType(currentMasterType);

          switch (currentMasterType) {
            case "buah":
              data = [
                document.getElementById("buahKode").value,
                document.getElementById("buahNama").value,
                document.getElementById("buahKategori").value,
                document.getElementById("buahSatuan").value,
                parseFloat(document.getElementById("buahHargaBeli").value),
                parseFloat(document.getElementById("buahHargaJual").value),
                parseFloat(document.getElementById("buahStokMin").value),
                document.getElementById("buahStatus").value,
              ];
              break;
            case "supplier":
              data = [
                document.getElementById("supplierKode").value,
                document.getElementById("supplierNama").value,
                document.getElementById("supplierKontak").value,
                document.getElementById("supplierAlamat").value,
                document.getElementById("supplierJenisBuah").value,
                document.getElementById("supplierTerms").value,
              ];
              break;
            case "pelanggan":
              data = [
                document.getElementById("pelangganKode").value,
                document.getElementById("pelangganNama").value,
                document.getElementById("pelangganJenis").value,
                document.getElementById("pelangganKontak").value,
                document.getElementById("pelangganAlamat").value,
                parseFloat(document.getElementById("pelangganLimit").value),
              ];
              break;
            case "biaya":
              data = [
                document.getElementById("biayaKode").value,
                document.getElementById("biayaNama").value,
                document.getElementById("biayaKategori").value,
                document.getElementById("biayaSubKategori").value,
                parseFloat(document.getElementById("biayaBudget").value),
                document.getElementById("biayaStatus").value,
              ];
              break;
          }

          await appendToSheet(sheetName, data);
          await system.loadAllData();

          const modalEl = document.getElementById("masterModal");
          if (modalEl) {
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
          }

          showAlert(
            `Data ${currentMasterType} berhasil ${
              editingData ? "diupdate" : "disimpan"
            }!`,
            "success"
          );
        } catch (error) {
          showAlert(`Error menyimpan data: ${error.message}`, "danger");
        }
      }

      function getSheetNameByType(masterType) {
        const mapping = {
          buah: SHEETS.MASTER_BUAH,
          supplier: SHEETS.MASTER_SUPPLIER,
          pelanggan: SHEETS.MASTER_PELANGGAN,
          biaya: SHEETS.MASTER_BIAYA,
        };
        return mapping[masterType];
      }

      function editMasterData(type, index) {
        const data = system.masterData[type][index + 1];
        showModal(type, data);
      }

      async function deleteMasterData(type, index) {
        if (confirm("Apakah Anda yakin ingin menghapus data ini?")) {
          showAlert(
            "Fitur delete membutuhkan implementasi Google Sheets API yang lebih kompleks",
            "warning"
          );
        }
      }

      // ==================== REPORT GENERATION ====================
      async function generateLaporan() {
        const startDate = new Date(
          document.getElementById("reportStartDate").value
        );
        const endDate = new Date(
          document.getElementById("reportEndDate").value
        );

        try {
          const laporan = await system.generateLaporanLabaRugi(
            startDate,
            endDate
          );

          const labaRugiContainer = document.getElementById("laporanLabaRugi");
          if (labaRugiContainer) {
            labaRugiContainer.innerHTML = `
        <div class="row">
          <div class="col-md-6">
            <table class="table table-bordered">
              <tr>
                <th>Pendapatan Penjualan</th>
                <td class="text-end">${formatCurrency(
                  laporan.totalPenjualan
                )}</td>
              </tr>
              <tr>
                <th>Harga Pokok Penjualan</th>
                <td class="text-end">${formatCurrency(
                  laporan.totalPembelian
                )}</td>
              </tr>
              <tr class="table-success">
                <th><strong>Laba Kotor</strong></th>
                <td class="text-end"><strong>${formatCurrency(
                  laporan.labaKotor
                )}</strong></td>
              </tr>
              <tr>
                <th>Biaya Operasional</th>
                <td class="text-end">${formatCurrency(laporan.totalBiaya)}</td>
              </tr>
              <tr class="table-primary">
                <th><strong>LABA BERSIH</strong></th>
                <td class="text-end"><strong>${formatCurrency(
                  laporan.labaBersih
                )}</strong></td>
              </tr>
            </table>
          </div>
        </div>
      `;
          }

          await generateLaporanStok();
        } catch (error) {
          showAlert("Error generating report: " + error.message, "danger");
        }
      }

      async function generateLaporanStok() {
        const stokContainer = document.getElementById("laporanStok");
        if (!stokContainer) return;

        stokContainer.innerHTML = "";

        system.masterData.buah.slice(1).forEach((buah) => {
          const [kode, nama] = buah;
          const currentStock = system.calculateCurrentStock(kode);

          const totalPembelian = system.transactions.pembelian
            .slice(1)
            .filter((t) => t[3] === kode)
            .reduce((sum, t) => sum + parseFloat(t[4] || 0), 0);

          const totalPenjualan = system.transactions.penjualan
            .slice(1)
            .filter((t) => t[3] === kode)
            .reduce((sum, t) => sum + parseFloat(t[4] || 0), 0);

          const hargaBeli = parseFloat(buah[4] || 0);
          const nilaiPersediaan = currentStock * hargaBeli;

          const row = document.createElement("tr");
          row.innerHTML = `
      <td>${nama}</td>
      <td>0 kg</td>
      <td>${totalPembelian.toFixed(1)} kg</td>
      <td>${totalPenjualan.toFixed(1)} kg</td>
      <td><strong>${currentStock.toFixed(1)} kg</strong></td>
      <td>${formatCurrency(nilaiPersediaan)}</td>
    `;
          stokContainer.appendChild(row);
        });
      }

      // ==================== INITIALIZATION ====================
      const system = new TokoBuahSystem();

      document.addEventListener("DOMContentLoaded", function () {
        const now = new Date();

        const pembelianTanggal = document.getElementById("pembelianTanggal");
        if (pembelianTanggal) pembelianTanggal.valueAsDate = now;

        const reportStartDate = document.getElementById("reportStartDate");
        if (reportStartDate)
          reportStartDate.valueAsDate = new Date(
            now.getFullYear(),
            now.getMonth(),
            1
          );

        const reportEndDate = document.getElementById("reportEndDate");
        if (reportEndDate) reportEndDate.valueAsDate = now;

        function updateDateTime() {
          const currentDateTime = document.getElementById("currentDateTime");
          if (currentDateTime) {
            currentDateTime.textContent = new Date().toLocaleString("id-ID");
          }
        }
        setInterval(updateDateTime, 1000);
        updateDateTime();

        system.loadAllData();

        const formPembelian = document.getElementById("formPembelian");
        if (formPembelian) {
          formPembelian.addEventListener("submit", async function (e) {
            e.preventDefault();

            const data = {
              tanggal: document.getElementById("pembelianTanggal").value,
              kodeSupplier: document.getElementById("pembelianSupplier").value,
              kodeBuah: document.getElementById("pembelianBuah").value,
              quantity: parseFloat(
                document.getElementById("pembelianQty").value
              ),
              hargaBeli: parseInt(
                document.getElementById("pembelianHarga").value
              ),
              keterangan: document.getElementById("pembelianKeterangan").value,
            };

            try {
              await system.simpanPembelian(data);
              showAlert("Pembelian berhasil disimpan!", "success");
              this.reset();
              document.getElementById("pembelianTanggal").valueAsDate =
                new Date();
            } catch (error) {
              showAlert(
                "Error menyimpan pembelian: " + error.message,
                "danger"
              );
            }
          });
        }

        const pembelianBuah = document.getElementById("pembelianBuah");
        if (pembelianBuah) {
          pembelianBuah.addEventListener("change", function () {
            const selectedOption = this.options[this.selectedIndex];
            const harga = selectedOption.getAttribute("data-harga");
            const pembelianHarga = document.getElementById("pembelianHarga");
            if (harga && pembelianHarga) {
              pembelianHarga.value = harga;
            }
          });
        }
      });

      window.generateLaporan = generateLaporan;
      window.system = system;
      window.showModal = showModal;
      window.saveMasterData = saveMasterData;
      window.editMasterData = editMasterData;
      window.deleteMasterData = deleteMasterData;
    </script>

    <!-- modal -->
    <!-- Modal untuk Master Data -->
    <div class="modal fade" id="masterModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="masterModalTitle">Tambah Data</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <!-- Form for Master Buah -->
            <form id="formMasterBuah" style="display: none">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Kode Buah</label>
                    <input
                      type="text"
                      class="form-control"
                      id="buahKode"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Nama Buah</label>
                    <input
                      type="text"
                      class="form-control"
                      id="buahNama"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Kategori</label>
                    <select class="form-select" id="buahKategori" required>
                      <option value="">Pilih Kategori</option>
                      <option value="Lokal">Lokal</option>
                      <option value="Import">Import</option>
                      <option value="Organik">Organik</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Satuan</label>
                    <select class="form-select" id="buahSatuan" required>
                      <option value="">Pilih Satuan</option>
                      <option value="kg">Kilogram (kg)</option>
                      <option value="pcs">Piece (pcs)</option>
                      <option value="box">Box</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Harga Beli Terakhir</label>
                    <input
                      type="number"
                      class="form-control"
                      id="buahHargaBeli"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Harga Jual Standar</label>
                    <input
                      type="number"
                      class="form-control"
                      id="buahHargaJual"
                      required
                    />
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Stok Minimum</label>
                    <input
                      type="number"
                      step="0.1"
                      class="form-control"
                      id="buahStokMin"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="buahStatus" required>
                      <option value="Active">Active</option>
                      <option value="Inactive">Inactive</option>
                    </select>
                  </div>
                </div>
              </div>
            </form>

            <!-- Form for Master Supplier -->
            <form id="formMasterSupplier" style="display: none">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Kode Supplier</label>
                    <input
                      type="text"
                      class="form-control"
                      id="supplierKode"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Nama Supplier</label>
                    <input
                      type="text"
                      class="form-control"
                      id="supplierNama"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Kontak</label>
                    <input
                      type="text"
                      class="form-control"
                      id="supplierKontak"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Alamat</label>
                    <textarea
                      class="form-control"
                      id="supplierAlamat"
                      rows="3"
                    ></textarea>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Jenis Buah yang Disupply</label>
                    <input
                      type="text"
                      class="form-control"
                      id="supplierJenisBuah"
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Terms Pembayaran</label>
                    <select class="form-select" id="supplierTerms">
                      <option value="Cash">Cash</option>
                      <option value="7 Hari">7 Hari</option>
                      <option value="30 Hari">30 Hari</option>
                    </select>
                  </div>
                </div>
              </div>
            </form>

            <!-- Form for Master Pelanggan -->
            <form id="formMasterPelanggan" style="display: none">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Kode Pelanggan</label>
                    <input
                      type="text"
                      class="form-control"
                      id="pelangganKode"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Nama Pelanggan</label>
                    <input
                      type="text"
                      class="form-control"
                      id="pelangganNama"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Jenis Pelanggan</label>
                    <select class="form-select" id="pelangganJenis" required>
                      <option value="Retail">Retail</option>
                      <option value="Grosir">Grosir</option>
                      <option value="Restoran">Restoran</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Kontak</label>
                    <input
                      type="text"
                      class="form-control"
                      id="pelangganKontak"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Alamat</label>
                    <textarea
                      class="form-control"
                      id="pelangganAlamat"
                      rows="3"
                    ></textarea>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Limit Kredit (Rp)</label>
                    <input
                      type="number"
                      class="form-control"
                      id="pelangganLimit"
                      value="0"
                    />
                  </div>
                </div>
              </div>
            </form>

            <!-- Form for Master Biaya -->
            <form id="formMasterBiaya" style="display: none">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Kode Biaya</label>
                    <input
                      type="text"
                      class="form-control"
                      id="biayaKode"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Nama Biaya</label>
                    <input
                      type="text"
                      class="form-control"
                      id="biayaNama"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Kategori Biaya</label>
                    <select class="form-select" id="biayaKategori" required>
                      <option value="Fixed">Fixed</option>
                      <option value="Variable">Variable</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Sub Kategori</label>
                    <select class="form-select" id="biayaSubKategori" required>
                      <option value="Operational">Operational</option>
                      <option value="Administrative">Administrative</option>
                      <option value="Personnel">Personnel</option>
                      <option value="Marketing">Marketing</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Budget Bulanan (Rp)</label>
                    <input
                      type="number"
                      class="form-control"
                      id="biayaBudget"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="biayaStatus" required>
                      <option value="Active">Active</option>
                      <option value="Inactive">Inactive</option>
                    </select>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Batal
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveMasterData()"
            >
              Simpan
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
